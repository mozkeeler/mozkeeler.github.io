
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>nsConvertToActualKeyGenParams 2: Electric Boogaloo - mozkeeler</title>
  <meta name="author" content="David Keeler">

  
  <meta name="description" content="As it turns out, untested code can contain multiple bugs. Here&rsquo;s some more
of nsConvertToActualKeyGenParams: 1
2
3
4
5
6
7
8
9
10
11
12
13
14 &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://mozkeeler.github.io/blog/2014/04/18/nsconverttoactualkeygenparams-2-electric-boogaloo">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="mozkeeler" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">mozkeeler</a></h1>
  
    <h2>Adventures at Mozilla</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://www.google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:mozkeeler.github.io" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">nsConvertToActualKeyGenParams 2: Electric Boogaloo</h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-04-18T16:28:09-07:00" pubdate data-updated="true"></time>
        
      </p>
    
  </header>


<div class="entry-content"><p>As it turns out, untested code can contain multiple bugs. Here&rsquo;s some more
of <code>nsConvertToActualKeyGenParams</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'>  <span class="k">while</span> <span class="p">(</span><span class="n">getNextNameValueFromECKeygenParamString</span><span class="p">(</span>
</span><span class='line'>          <span class="n">next_input</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">name_len</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">value_len</span><span class="p">,</span>
</span><span class='line'>          <span class="n">next_input</span><span class="p">))</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">PL_strncmp</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;curve&quot;</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">min</span><span class="p">(</span><span class="n">name_len</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>      <span class="n">curve</span> <span class="o">=</span> <span class="n">PL_strndup</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">value_len</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">PL_strncmp</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;popcert&quot;</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">min</span><span class="p">(</span><span class="n">name_len</span><span class="p">,</span> <span class="mi">7</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>      <span class="kt">char</span> <span class="o">*</span><span class="n">certstr</span> <span class="o">=</span> <span class="n">PL_strndup</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">value_len</span><span class="p">);</span>
</span><span class='line'>      <span class="k">if</span> <span class="p">(</span><span class="n">certstr</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">keyPairInfo</span><span class="o">-&gt;</span><span class="n">ecPopCert</span> <span class="o">=</span> <span class="n">CERT_ConvertAndDecodeCertificate</span><span class="p">(</span><span class="n">certstr</span><span class="p">);</span>
</span><span class='line'>        <span class="n">PL_strfree</span><span class="p">(</span><span class="n">certstr</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">keyPairInfo</span><span class="o">-&gt;</span><span class="n">ecPopCert</span><span class="p">)</span>
</span><span class='line'>        <span class="p">{</span>
</span><span class='line'>          <span class="n">keyPairInfo</span><span class="o">-&gt;</span><span class="n">ecPopPubKey</span> <span class="o">=</span> <span class="n">CERT_ExtractPublicKey</span><span class="p">(</span><span class="n">keyPairInfo</span><span class="o">-&gt;</span><span class="n">ecPopCert</span><span class="p">);</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="n">keyPairInfo</span><span class="o">-&gt;</span><span class="n">ecPopPubKey</span><span class="p">)</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>    <span class="n">returnParams</span> <span class="o">=</span> <span class="n">SECITEM_DupItem</span><span class="p">(</span><span class="o">&amp;</span><span class="n">keyPairInfo</span><span class="o">-&gt;</span><span class="n">ecPopPubKey</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ec</span><span class="p">.</span><span class="n">DEREncodedParams</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>keyPairInfo-&gt;ecPopPubKey</code> is a <code>SECKEYPublicKey</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="k">struct</span> <span class="n">SECKEYPublicKeyStr</span> <span class="p">{</span>
</span><span class='line'>  <span class="n">PLArenaPool</span> <span class="o">*</span><span class="n">arena</span><span class="p">;</span>
</span><span class='line'>  <span class="n">KeyType</span> <span class="n">keyType</span><span class="p">;</span>
</span><span class='line'>  <span class="n">PK11SlotInfo</span> <span class="o">*</span><span class="n">pkcs11Slot</span><span class="p">;</span>
</span><span class='line'>  <span class="n">CK_OBJECT_HANDLE</span> <span class="n">pkcs11ID</span><span class="p">;</span>
</span><span class='line'>  <span class="k">union</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">SECKEYRSAPublicKey</span> <span class="n">rsa</span><span class="p">;</span>
</span><span class='line'>    <span class="n">SECKEYDSAPublicKey</span> <span class="n">dsa</span><span class="p">;</span>
</span><span class='line'>    <span class="n">SECKEYDHPublicKey</span>  <span class="n">dh</span><span class="p">;</span>
</span><span class='line'>    <span class="n">SECKEYKEAPublicKey</span> <span class="n">kea</span><span class="p">;</span>
</span><span class='line'>    <span class="n">SECKEYFortezzaPublicKey</span> <span class="n">fortezza</span><span class="p">;</span>
</span><span class='line'>    <span class="n">SECKEYECPublicKey</span>  <span class="n">ec</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span> <span class="n">u</span><span class="p">;</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'><span class="k">typedef</span> <span class="k">struct</span> <span class="n">SECKEYPublicKeyStr</span> <span class="n">SECKEYPublicKey</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Recall that <code>certstr</code> comes more or less directly from
<code>window.crypto.generateCRMFRequest</code>, so it could be anything. This code passes
it to <code>CERT_ConvertAndDecodeCertificate</code> and then extracts the public key into
<code>keyPairInfo-&gt;ecPopPubKey</code>. The code then assumes that public key is an
elliptic curve key without checking first. It turns out, this can actually
crash Firefox.</p>

<p>It would be easy to say do not use union. Indeed, modern typesystems can be
quite helpful when different types of data can have similar operations
performed on them. However, seeing as we have a large amount of legacy code
that does use unions, we should probably put some effort into ensuring that
they&rsquo;re handled safely. In particular, that means always preceding the
de-unionification with a type check. And again, going back to writing
meaningful tests, when code expects a certain type of input, there should be
tests that give it something unexpected.</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">David Keeler</span></span>

      








  


<time datetime="2014-04-18T16:28:09-07:00" pubdate data-updated="true"></time>
      


    </p>
    
      <div class="sharing">
  
  <a href="//twitter.com/share" class="twitter-share-button" data-url="http://mozkeeler.github.io/blog/2014/04/18/nsconverttoactualkeygenparams-2-electric-boogaloo/" data-via="" data-counturl="http://mozkeeler.github.io/blog/2014/04/18/nsconverttoactualkeygenparams-2-electric-boogaloo/" >Tweet</a>
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2014/04/16/leaky-input-parsing-in-nsconverttoactualkeygenparams/" title="Previous Post: Leaky Input Parsing in  nsConvertToActualKeyGenParams">&laquo; Leaky Input Parsing in  nsConvertToActualKeyGenParams</a>
      
      
        <a class="basic-alignment right" href="/blog/2014/05/28/personal-debug-number-ifdefs/" title="Next Post: Personal Debug #ifdefs">Personal Debug #ifdefs &raquo;</a>
      
    </p>
  </footer>
</article>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2015/02/02/my-weekend-with-pam/">My Weekend With PAM</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/06/03/history-lessons/">History Lessons</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/05/28/personal-debug-number-ifdefs/">Personal Debug #ifdefs</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/04/18/nsconverttoactualkeygenparams-2-electric-boogaloo/">nsConvertToActualKeyGenParams 2: Electric Boogaloo</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/04/16/leaky-input-parsing-in-nsconverttoactualkeygenparams/">Leaky Input Parsing in nsConvertToActualKeyGenParams</a>
      </li>
    
  </ul>
</section>





  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2015 - David Keeler -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
