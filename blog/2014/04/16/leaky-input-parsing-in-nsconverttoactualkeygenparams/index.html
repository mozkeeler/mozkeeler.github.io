
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Leaky Input Parsing in nsConvertToActualKeyGenParams - mozkeeler</title>
  <meta name="author" content="David Keeler">

  
  <meta name="description" content="Consider the following code (modified for clarity): 1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35 &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://mozkeeler.github.io/blog/2014/04/16/leaky-input-parsing-in-nsconverttoactualkeygenparams">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="mozkeeler" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">mozkeeler</a></h1>
  
    <h2>Adventures at Mozilla</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://www.google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:mozkeeler.github.io" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Leaky Input Parsing in nsConvertToActualKeyGenParams</h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-04-16T13:52:15-07:00" pubdate data-updated="true">Apr 16<span>th</span>, 2014</time>
        
      </p>
    
  </header>


<div class="entry-content"><p>Consider the following code (modified for clarity):</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'><span class="k">static</span> <span class="kt">void</span><span class="o">*</span>
</span><span class='line'><span class="n">nsConvertToActualKeyGenParams</span><span class="p">(</span><span class="n">uint32_t</span> <span class="n">keyGenMech</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">params</span><span class="p">,</span>
</span><span class='line'>                              <span class="n">uint32_t</span> <span class="n">paramLen</span><span class="p">,</span> <span class="n">int32_t</span> <span class="n">keySize</span><span class="p">,</span>
</span><span class='line'>                              <span class="n">nsKeyPairInfo</span> <span class="o">*</span><span class="n">keyPairInfo</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="kt">char</span> <span class="o">*</span><span class="n">curve</span> <span class="o">=</span> <span class="n">nullptr</span><span class="p">;</span>
</span><span class='line'>  <span class="kt">char</span> <span class="o">*</span><span class="n">next_input</span> <span class="o">=</span> <span class="n">params</span><span class="p">;</span>
</span><span class='line'>  <span class="kt">char</span> <span class="o">*</span><span class="n">name</span> <span class="o">=</span> <span class="n">nullptr</span><span class="p">;</span>
</span><span class='line'>  <span class="kt">char</span> <span class="o">*</span><span class="n">value</span> <span class="o">=</span> <span class="n">nullptr</span><span class="p">;</span>
</span><span class='line'>  <span class="kt">int</span> <span class="n">name_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>  <span class="kt">int</span> <span class="n">value_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">while</span> <span class="p">(</span><span class="n">getNextNameValueFromECKeygenParamString</span><span class="p">(</span>
</span><span class='line'>          <span class="n">next_input</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">name_len</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">value_len</span><span class="p">,</span>
</span><span class='line'>          <span class="n">next_input</span><span class="p">))</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">PL_strncmp</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;curve&quot;</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">min</span><span class="p">(</span><span class="n">name_len</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>      <span class="n">curve</span> <span class="o">=</span> <span class="n">PL_strndup</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">value_len</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">PL_strncmp</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;popcert&quot;</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">min</span><span class="p">(</span><span class="n">name_len</span><span class="p">,</span> <span class="mi">7</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>      <span class="kt">char</span> <span class="o">*</span><span class="n">certstr</span> <span class="o">=</span> <span class="n">PL_strndup</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">value_len</span><span class="p">);</span>
</span><span class='line'>      <span class="k">if</span> <span class="p">(</span><span class="n">certstr</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">keyPairInfo</span><span class="o">-&gt;</span><span class="n">ecPopCert</span> <span class="o">=</span> <span class="n">CERT_ConvertAndDecodeCertificate</span><span class="p">(</span><span class="n">certstr</span><span class="p">);</span>
</span><span class='line'>        <span class="n">PL_strfree</span><span class="p">(</span><span class="n">certstr</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">keyPairInfo</span><span class="o">-&gt;</span><span class="n">ecPopCert</span><span class="p">)</span>
</span><span class='line'>        <span class="p">{</span>
</span><span class='line'>          <span class="n">keyPairInfo</span><span class="o">-&gt;</span><span class="n">ecPopPubKey</span> <span class="o">=</span> <span class="n">CERT_ExtractPublicKey</span><span class="p">(</span><span class="n">keyPairInfo</span><span class="o">-&gt;</span><span class="n">ecPopCert</span><span class="p">);</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// further processing, etc.</span>
</span></code></pre></td></tr></table></div></figure>


<p>The purpose of <code>nsConvertToActualKeyGenParams</code> is to parse and process a string
consisting of semicolon-delimited key:value pairs. The known keys are <code>"curve"</code>
and <code>"popcert"</code>. The function <code>getNextNameValueFromECKeygenParamString</code>
tokenizes the input. The only state that function keeps is how far along in
<code>params</code> it has gotten. Let&rsquo;s assume there&rsquo;s nothing wrong with it. If you&rsquo;re
the suspicious sort, you may have already noticed what can go wrong with
<code>nsConvertToActualKeyGenParams</code>.</p>

<p>What happens if a string like <code>"curve=secp521r1;curve=secp521r1"</code> is given as
its input? <code>curve</code> will first point to a freshly-allocated copy of
<code>"secp521r1"</code> and then it will point to another freshly-allocated copy of
<code>"secp521r1"</code>. Of course, the issue is not efficiency &ndash; it&rsquo;s that the
memory for that first copy has been leaked. Even worse, if multiple
<code>"popcert"</code> values are given, each one will leak an entire <code>CERTCertificate</code>.</p>

<p>If this were the argument-parsing code of a locally-run, non-setuid,
short-lived utility program, it would probably be no more than a
papercut-correctness bug. Sure, some memory could be leaked, but nobody would
call it with nonsensical input, right? Unfortunately this is more serious than
a local correctness issue. The input to <code>nsConvertToActualKeyGenParams</code> gets
passed unchanged from <code>window.crypto.generateCRMFRequest</code>, meaning that any
page could trigger this bug.</p>

<p>Looking at the history of this code, it appears to have landed as part of a
large commit with no tests. The reviewer even mentions that the key:value
parsing should be in its own function, which maybe would have made this bug
more obvious. In any case, the lessons learned from this should already be
familiar. Large pieces of new code should be broken into smaller pices, tested
thoroughly, and reviewed carefully. Additionally, old code with insufficient
test coverage should either be exercised by new tests or removed if it is no
longer necessary.</p>

<p>As a colleague pointed out to me, it&rsquo;s easy to say, &ldquo;Well obviously everything
should have thorough test-coverage.&rdquo; The real question is, why does code land
without tests? Or, to put it positively, how can we ensure that new features
land with tests? One suggestion is to have a publicly documented and
agreed-upon set of standards for landing code. We do ostensibly have that at
Mozilla, but it appears to fall apart under time pressure. Anecdotally,
features in early B2G builds would often regress due to a near absence of
tests. The engineers were obviously under a tight deadline, and I imagine it
was a natural reaction to neglect something not seen as essential: the tests.
So, perhaps that&rsquo;s the answer: we need to ensure buy-in to the idea that tests
are as essential as the code itself.</p>

<p>That said, I&rsquo;m not sure the presence of tests alone would have caught this bug.
It would have required a test case with a duplicate key:value pair and some
sort of memory-leak detection. However, the act of writing tests may have
inspired the very question I asked early in this post, which could have led
to finding the bug.</p>

<p>For those curious, the fix for this code consisted of null-checking <code>curve</code> and
<code>keyPairInfo-&gt;ecPopPubKey</code> respectively before allocating and assigning to them
new memory.</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">David Keeler</span></span>

      








  


<time datetime="2014-04-16T13:52:15-07:00" pubdate data-updated="true">Apr 16<span>th</span>, 2014</time>
      


    </p>
    
      <div class="sharing">
  
  <a href="//twitter.com/share" class="twitter-share-button" data-url="http://mozkeeler.github.io/blog/2014/04/16/leaky-input-parsing-in-nsconverttoactualkeygenparams/" data-via="mozkeeler" data-counturl="http://mozkeeler.github.io/blog/2014/04/16/leaky-input-parsing-in-nsconverttoactualkeygenparams/" >Tweet</a>
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2014/04/16/whats-all-this/" title="Previous Post: What's all this, then?">&laquo; What's all this, then?</a>
      
      
    </p>
  </footer>
</article>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2014/04/16/leaky-input-parsing-in-nsconverttoactualkeygenparams/">Leaky Input Parsing in nsConvertToActualKeyGenParams</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/04/16/whats-all-this/">What's All This, Then?</a>
      </li>
    
  </ul>
</section>





  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2014 - David Keeler -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
